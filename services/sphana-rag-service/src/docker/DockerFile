FROM python:3.12-slim as builder

WORKDIR /source
COPY requirements.txt .
COPY src/python/ .
COPY src/resources/ .

RUN pip install --no-cache-dir -r requirements.txt

RUN python -m nuitka \
    --mingw64 \
    --standalone \
    --include-data-dir=/source/src/resources=resources \
    --output-dir=/output \
    /source/src/python/main.py



# # Multi-stage build for optimized Docker image
# # Stage 1: Build dependencies and compile packages
# FROM nvidia/cuda:12.8.0-runtime-ubuntu22.04 AS builder

# # Set environment variables for build stage
# ENV DEBIAN_FRONTEND=noninteractive

# # Install build dependencies (only needed during compilation)
# RUN apt-get update && apt-get install -y \
#     python3-dev \
#     python3-pip \
#     build-essential \
#     cmake

# # Create symbolic link for python
# RUN ln -s /usr/bin/python3 /usr/bin/python

# # Copy requirements file
# COPY requirements.txt .

# # Install Python dependencies to user directory (for easier copying)
# RUN pip3 install --no-cache-dir --upgrade pip setuptools wheel
# RUN pip3 install --no-cache-dir --user -r requirements.txt

# # Stage 2: Runtime image with minimal dependencies
# FROM nvidia/cuda:12.8.0-runtime-ubuntu22.04 AS runtime

# # Set environment variables
# ENV DEBIAN_FRONTEND=noninteractive
# ENV PYTHONPATH=/app/src/python
# ENV FLASK_ENV=production
# ENV FLASK_APP=main.py
# ENV PATH=/root/.local/bin:$PATH

# # Install only runtime dependencies (no build tools)
# RUN apt-get update && apt-get install -y \
#     python3 \
#     && rm -rf /var/lib/apt/lists/* \
#     && apt-get clean

# # Create symbolic link for python
# RUN ln -s /usr/bin/python3 /usr/bin/python

# # Copy compiled Python packages from builder stage
# COPY --from=builder /root/.local /root/.local

# # Set working directory
# WORKDIR /app

# # Create necessary directories
# RUN mkdir -p /app/src/resources
# RUN mkdir -p /app/src/python

# # Copy the Python source code
# COPY src/python/ /app/src/python/
# COPY src/resources/ /app/src/resources/

# # Expose the port that gRPC runs on
# EXPOSE 5001

# # Command to run the application
# CMD ["python", "src/python/main.py"]
